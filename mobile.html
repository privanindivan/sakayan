<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sakayan - PH Jeepney Routes</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
            height: 100vh;
        }

        #map {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        .location-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1000;
            background: white;
            width: 46px;
            height: 46px;
            border-radius: 50%;
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: none;
            font-size: 22px;
        }

        .location-btn:active {
            transform: scale(0.95);
        }

        .toggle-container {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: white;
            border-radius: 30px;
            padding: 10px 18px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .toggle-label {
            font-size: 15px;
            font-weight: 600;
            color: #333;
        }

        .toggle-switch {
            position: relative;
            width: 52px;
            height: 30px;
            background: #ccc;
            border-radius: 15px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .toggle-switch.active {
            background: #4CAF50;
        }

        .toggle-slider {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .toggle-switch.active .toggle-slider {
            transform: translateX(22px);
        }

        .bottom-hint {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 900;
            background: linear-gradient(to top, rgba(0,0,0,0.85), transparent);
            padding: 50px 20px 20px 20px;
            text-align: center;
            color: white;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            pointer-events: none;
        }

        .bottom-hint.visible {
            transform: translateY(0);
            pointer-events: auto;
        }

        .hint-text {
            font-size: 17px;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .bottom-sheet {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 1001;
            background: white;
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -4px 24px rgba(0,0,0,0.25);
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
            max-height: 70vh;
            overflow-y: auto;
        }

        .bottom-sheet.visible {
            transform: translateY(0);
        }

        .sheet-header {
            position: sticky;
            top: 0;
            background: white;
            z-index: 10;
            padding-top: 12px;
            border-radius: 20px 20px 0 0;
        }

        .sheet-handle {
            width: 40px;
            height: 5px;
            background: #ddd;
            border-radius: 3px;
            margin: 0 auto 16px auto;
            cursor: grab;
        }

        .sheet-handle:active {
            cursor: grabbing;
        }

        .sheet-content {
            padding: 0 20px 30px 20px;
        }

        .sheet-title {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 20px;
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #555;
            margin-bottom: 10px;
        }

        .form-input {
            width: 100%;
            padding: 14px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: #4CAF50;
        }

        .vehicle-types {
            display: flex;
            gap: 10px;
        }

        .vehicle-btn {
            flex: 1;
            padding: 14px 10px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s;
            text-align: center;
        }

        .vehicle-btn.active {
            background: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }

        .clear-btn {
            width: 100%;
            padding: 14px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 12px;
        }

        .custom-marker {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }

        .start-marker {
            background: #4CAF50;
        }

        .end-marker {
            background: #f44336;
        }

        .waypoint-marker {
            background: #FF9800;
        }

        .search-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            z-index: 2000;
            display: none;
            flex-direction: column;
        }

        .search-overlay.visible {
            display: flex;
        }

        .search-header {
            padding: 16px 20px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .back-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
        }

        .search-title {
            font-size: 18px;
            font-weight: 700;
            flex: 1;
        }

        .search-inputs {
            padding: 20px;
        }

        .search-input-group {
            margin-bottom: 16px;
        }

        .search-input {
            width: 100%;
            padding: 14px 14px 14px 44px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 15px;
            position: relative;
        }

        .search-input:focus {
            outline: none;
            border-color: #4CAF50;
        }

        .search-icon {
            position: absolute;
            left: 34px;
            top: 30px;
            font-size: 18px;
            color: #666;
        }

        .search-btn {
            width: 100%;
            padding: 16px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            margin-top: 20px;
        }

        .poi-suggestions {
            padding: 0 20px;
            max-height: 200px;
            overflow-y: auto;
        }

        .poi-item {
            padding: 12px;
            background: #f5f5f5;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
        }

        .poi-item:active {
            background: #e0e0e0;
        }

        .poi-name {
            font-weight: 600;
            font-size: 14px;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .loading-overlay.visible {
            display: flex;
        }

        .loading-content {
            background: white;
            padding: 30px;
            border-radius: 16px;
            text-align: center;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4CAF50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .swipe-tab {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 999;
            background: white;
            padding: 12px 0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            text-align: center;
            cursor: pointer;
            display: none;
        }

        .swipe-tab.visible {
            display: block;
        }

        .waypoint-counter {
            font-size: 14px;
            color: #666;
            margin-bottom: 16px;
        }
    </style>
</head>
<body>

<div id="map"></div>

<button class="location-btn" onclick="goToMyLocation()">üìç</button>
<button class="location-btn" onclick="openSearchOverlay()" style="left: 80px;">üîç</button>

<div class="toggle-container">
    <span class="toggle-label">‚ûï Add Route</span>
    <div class="toggle-switch" id="toggleSwitch" onclick="toggleAddMode()">
        <div class="toggle-slider"></div>
    </div>
</div>

<div class="search-overlay" id="searchOverlay">
    <div class="search-header">
        <button class="back-btn" onclick="closeSearchOverlay()">‚Üê</button>
        <div class="search-title">Find Routes</div>
    </div>
    <div class="search-inputs">
        <div class="search-input-group" style="position: relative;">
            <span class="search-icon">üü¢</span>
            <input type="text" class="search-input" id="searchFrom" placeholder="From (e.g., Cubao)" oninput="showFromSuggestions(this.value)">
        </div>
        <div class="poi-suggestions" id="fromSuggestions"></div>
        
        <div class="search-input-group" style="position: relative;">
            <span class="search-icon">üî¥</span>
            <input type="text" class="search-input" id="searchTo" placeholder="To (e.g., Quezon Ave)" oninput="showToSuggestions(this.value)">
        </div>
        <div class="poi-suggestions" id="toSuggestions"></div>
        
        <button class="search-btn" onclick="searchRoutes()">üîç Find Routes</button>
    </div>
</div>

<div class="bottom-hint" id="bottomHint">
    <div class="hint-text">üìç Tap to add waypoints</div>
</div>

<div class="swipe-tab" id="swipeTab" onclick="openBottomSheet()">
    <div style="width: 40px; height: 4px; background: #ddd; border-radius: 2px; margin: 0 auto 8px;"></div>
    <div style="font-size: 13px; color: #666; font-weight: 600;">‚¨ÜÔ∏è Swipe up for details</div>
</div>

<div class="bottom-sheet" id="bottomSheet">
    <div class="sheet-header">
        <div class="sheet-handle" id="sheetHandle"></div>
    </div>
    <div class="sheet-content">
        <div class="sheet-title">Route Details</div>
        <div class="waypoint-counter" id="waypointCounter">0 waypoints</div>

        <div class="form-group">
            <label class="form-label">Waypoint Names (optional)</label>
            <div id="waypointInputs"></div>
        </div>

        <div class="form-group">
            <label class="form-label">Vehicle Type</label>
            <div class="vehicle-types">
                <button class="vehicle-btn active" data-type="jeepney" onclick="selectVehicle('jeepney')">üöå Jeepney</button>
                <button class="vehicle-btn" data-type="tricycle" onclick="selectVehicle('tricycle')">üõ∫ Tricycle</button>
                <button class="vehicle-btn" data-type="puv" onclick="selectVehicle('puv')">üöê UV</button>
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">Your Name</label>
            <input type="text" class="form-input" id="contributorName" placeholder="Contributor name">
        </div>

        <button class="btn" style="background: #4CAF50; color: white; padding: 14px; border-radius: 10px; margin-top: 8px;" onclick="saveRoute()">üíæ Save Route</button>
        <button class="clear-btn" onclick="clearAll()">üóëÔ∏è Clear All</button>
        <div style="margin-top: 12px; padding: 12px; background: #f0f9ff; border-radius: 8px; font-size: 13px; color: #666; text-align: center;">
            üí° Swipe down or tap map to close
        </div>
    </div>
</div>

<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
        <div class="spinner"></div>
        <div>Finding routes...</div>
    </div>
</div>

<script>
    const map = L.map('map').setView([14.5995, 120.9842], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap',
        maxZoom: 19
    }).addTo(map);

    let userLocationMarker = null;
    let userCurrentLocation = null;
    let addModeActive = false;
    let waypoints = [];
    let routeLines = [];
    let selectedVehicle = 'jeepney';
    let selectedFromPOI = null;
    let selectedToPOI = null;

    const knownPOIs = [
        { name: 'Cubao', lat: 14.6191, lng: 121.0509 },
        { name: 'Quezon Ave', lat: 14.6325, lng: 121.0374 },
        { name: 'Manila City Hall', lat: 14.5935, lng: 120.9820 },
        { name: 'SM North', lat: 14.6565, lng: 121.0295 },
        { name: 'Ayala', lat: 14.5547, lng: 121.0244 },
        { name: 'Divisoria', lat: 14.6013, lng: 120.9747 },
        { name: 'Quiapo', lat: 14.5981, lng: 120.9844 },
        { name: 'Taft Avenue', lat: 14.5895, lng: 120.9836 },
        { name: 'Ortigas', lat: 14.5865, lng: 121.0568 },
        { name: 'Makati', lat: 14.5547, lng: 121.0244 }
    ];

    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            (position) => {
                const { latitude, longitude } = position.coords;
                userCurrentLocation = { lat: latitude, lng: longitude };
                map.setView([latitude, longitude], 15);
                
                userLocationMarker = L.marker([latitude, longitude], {
                    icon: L.divIcon({
                        html: '<div style="width:14px;height:14px;background:#007AFF;border-radius:50%;border:2px solid white;box-shadow:0 2px 6px rgba(0,0,0,0.3);"></div>',
                        iconSize: [14, 14]
                    })
                }).addTo(map);
                
                document.getElementById('searchFrom').value = 'My Location';
                selectedFromPOI = { name: 'My Location', lat: latitude, lng: longitude };
            }
        );
    }

    function goToMyLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const { latitude, longitude } = position.coords;
                    map.setView([latitude, longitude], 16, { animate: true });
                    if (userLocationMarker) userLocationMarker.setLatLng([latitude, longitude]);
                }
            );
        }
    }

    function toggleAddMode() {
        addModeActive = !addModeActive;
        const toggle = document.getElementById('toggleSwitch');
        const hint = document.getElementById('bottomHint');
        
        if (addModeActive) {
            toggle.classList.add('active');
            hint.classList.add('visible');
        } else {
            toggle.classList.remove('active');
            hint.classList.remove('visible');
        }
    }

    function createMarker(latlng, index) {
        const isStart = index === 0;
        const isEnd = index === waypoints.length - 1;
        const markerClass = isStart ? 'start-marker' : (isEnd ? 'end-marker' : 'waypoint-marker');
        
        return L.marker(latlng, {
            icon: L.divIcon({
                html: `<div class="custom-marker ${markerClass}"></div>`,
                iconSize: [16, 16],
                iconAnchor: [8, 8]
            })
        });
    }

    map.on('click', function(e) {
        // If sheet is open, close it when clicking map
        if (sheet.classList.contains('visible')) {
            closeBottomSheet();
            return;
        }
        
        if (!addModeActive) return;

        const { lat, lng } = e.latlng;
        const marker = createMarker([lat, lng], waypoints.length);
        marker.on('click', () => openBottomSheet());
        marker.addTo(map);

        waypoints.push({ latlng: [lat, lng], marker: marker, name: '' });
        updateWaypointCounter();
        updateWaypointInputs();
        
        if (waypoints.length >= 2) {
            calculateRoute();
            document.getElementById('swipeTab').classList.add('visible');
        }
    });

    function updateWaypointCounter() {
        document.getElementById('waypointCounter').textContent = `${waypoints.length} waypoint${waypoints.length !== 1 ? 's' : ''}`;
    }

    function updateWaypointInputs() {
        const container = document.getElementById('waypointInputs');
        container.innerHTML = '';
        
        waypoints.forEach((wp, idx) => {
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'form-input';
            const label = idx === 0 ? 'Start' : (idx === waypoints.length - 1 ? 'End' : `Stop ${idx}`);
            input.placeholder = `${label} name (optional)`;
            input.value = wp.name;
            input.style.marginBottom = '8px';
            input.oninput = (e) => { waypoints[idx].name = e.target.value; };
            container.appendChild(input);
        });
    }

    async function calculateRoute() {
        if (waypoints.length < 2) return;
        showLoading(true);

        try {
            const coords = waypoints.map(wp => `${wp.latlng[1]},${wp.latlng[0]}`).join(';');
            const url = `https://router.project-osrm.org/route/v1/driving/${coords}?overview=full&geometries=geojson`;
            const response = await fetch(url);
            const data = await response.json();

            if (data.code === 'Ok' && data.routes && data.routes.length > 0) {
                drawRoute(data.routes[0]);
            }
        } catch (error) {
            console.error('Route error:', error);
        }
        showLoading(false);
    }

    function drawRoute(route) {
        routeLines.forEach(line => map.removeLayer(line));
        routeLines = [];

        const coordinates = route.geometry.coordinates.map(coord => [coord[1], coord[0]]);
        const polyline = L.polyline(coordinates, {
            color: '#4CAF50',
            weight: 5,
            opacity: 0.8
        }).addTo(map);
        
        routeLines.push(polyline);
        map.fitBounds(polyline.getBounds(), { padding: [50, 50] });
    }

    function findNearestPOI(query) {
        if (!query) return [];
        const q = query.toLowerCase();
        return knownPOIs.filter(poi => poi.name.toLowerCase().includes(q));
    }

    function showFromSuggestions(query) {
        const suggestions = findNearestPOI(query);
        const container = document.getElementById('fromSuggestions');
        
        if (suggestions.length === 0 || query.toLowerCase() === 'my location') {
            container.innerHTML = '';
            return;
        }
        
        container.innerHTML = suggestions.map(poi => `
            <div class="poi-item" onclick="selectFromPOI('${poi.name}')">
                <div class="poi-name">${poi.name}</div>
            </div>
        `).join('');
    }

    function showToSuggestions(query) {
        const suggestions = findNearestPOI(query);
        const container = document.getElementById('toSuggestions');
        
        if (suggestions.length === 0) {
            container.innerHTML = '';
            return;
        }
        
        container.innerHTML = suggestions.map(poi => `
            <div class="poi-item" onclick="selectToPOI('${poi.name}')">
                <div class="poi-name">${poi.name}</div>
            </div>
        `).join('');
    }

    window.selectFromPOI = (name) => {
        document.getElementById('searchFrom').value = name;
        selectedFromPOI = knownPOIs.find(p => p.name === name);
        document.getElementById('fromSuggestions').innerHTML = '';
    };

    window.selectToPOI = (name) => {
        document.getElementById('searchTo').value = name;
        selectedToPOI = knownPOIs.find(p => p.name === name);
        document.getElementById('toSuggestions').innerHTML = '';
    };

    async function searchRoutes() {
        const fromQuery = document.getElementById('searchFrom').value.trim().toLowerCase();
        const toQuery = document.getElementById('searchTo').value.trim().toLowerCase();
        
        if (!fromQuery || !toQuery) {
            alert('Please enter both locations');
            return;
        }
        
        let fromPOI = selectedFromPOI;
        if (!fromPOI) {
            if (fromQuery === 'my location' && userCurrentLocation) {
                fromPOI = { name: 'My Location', lat: userCurrentLocation.lat, lng: userCurrentLocation.lng };
            } else {
                fromPOI = knownPOIs.find(p => p.name.toLowerCase().includes(fromQuery));
            }
        }
        
        let toPOI = selectedToPOI;
        if (!toPOI) {
            toPOI = knownPOIs.find(p => p.name.toLowerCase().includes(toQuery));
        }
        
        if (!fromPOI || !toPOI) {
            alert('Location not found');
            return;
        }
        
        closeSearchOverlay();
        clearAll();
        
        waypoints = [
            { latlng: [fromPOI.lat, fromPOI.lng], name: fromPOI.name, marker: null },
            { latlng: [toPOI.lat, toPOI.lng], name: toPOI.name, marker: null }
        ];
        
        waypoints.forEach((wp, idx) => {
            wp.marker = createMarker(wp.latlng, idx);
            wp.marker.on('click', () => openBottomSheet());
            wp.marker.addTo(map);
        });
        
        updateWaypointCounter();
        updateWaypointInputs();
        calculateRoute();
        document.getElementById('swipeTab').classList.add('visible');
    }

    let startY = 0, currentY = 0, isDragging = false;
    const handle = document.getElementById('sheetHandle');
    const sheet = document.getElementById('bottomSheet');
    const swipeTab = document.getElementById('swipeTab');

    handle.addEventListener('touchstart', (e) => {
        isDragging = true;
        startY = e.touches[0].clientY;
    });

    document.addEventListener('touchmove', (e) => {
        if (!isDragging) return;
        currentY = e.touches[0].clientY;
        const diff = currentY - startY;
        if (diff > 0) sheet.style.transform = `translateY(${diff}px)`;
    });

    document.addEventListener('touchend', () => {
        if (!isDragging) return;
        isDragging = false;
        const diff = currentY - startY;
        
        if (diff > 100) {
            // Just close, don't auto-save
            closeBottomSheet();
        } else {
            sheet.style.transform = 'translateY(0)';
        }
    });

    function openBottomSheet() {
        sheet.classList.add('visible');
        swipeTab.classList.remove('visible');
    }

    function closeBottomSheet() {
        sheet.classList.remove('visible');
        if (waypoints.length > 0) swipeTab.classList.add('visible');
    }

    function selectVehicle(type) {
        selectedVehicle = type;
        document.querySelectorAll('[data-type]').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.type === type);
        });
    }

    function openSearchOverlay() {
        document.getElementById('searchOverlay').classList.add('visible');
    }

    function closeSearchOverlay() {
        document.getElementById('searchOverlay').classList.remove('visible');
        document.getElementById('fromSuggestions').innerHTML = '';
        document.getElementById('toSuggestions').innerHTML = '';
    }

    function saveRoute() {
        const contributor = document.getElementById('contributorName').value.trim();
        if (!contributor) {
            alert('Please enter your name');
            return;
        }
        
        if (waypoints.length < 2) {
            alert('Please add at least 2 waypoints');
            return;
        }

        const route = {
            waypoints: waypoints.map(wp => ({ latlng: wp.latlng, name: wp.name })),
            vehicleType: selectedVehicle,
            contributor: contributor,
            timestamp: new Date().toISOString()
        };

        try {
            let savedRoutes = JSON.parse(localStorage.getItem('sakayanRoutes') || '[]');
            savedRoutes.push(route);
            localStorage.setItem('sakayanRoutes', JSON.stringify(savedRoutes));
            alert(`‚úÖ Route saved! Total: ${savedRoutes.length}`);
            closeBottomSheet();
        } catch (error) {
            console.error('Save error:', error);
            alert('Failed to save route');
        }
    }

    function clearAll() {
        waypoints.forEach(wp => { if (wp.marker) map.removeLayer(wp.marker); });
        waypoints = [];
        routeLines.forEach(line => map.removeLayer(line));
        routeLines = [];
        updateWaypointCounter();
        updateWaypointInputs();
        closeBottomSheet();
    }

    function showLoading(show) {
        document.getElementById('loadingOverlay').classList.toggle('visible', show);
    }
</script>
</body>
</html>
